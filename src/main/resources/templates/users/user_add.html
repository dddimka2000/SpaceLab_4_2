<!DOCTYPE html>

<html
        lang="en"
        class="light-style layout-navbar-fixed layout-menu-fixed"
        layout:decorate="~{layout.html}"
        xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <title>Content page</title>
</head>

<body>

<section layout:fragment="content">
    <div class="container-xxl flex-grow-1 container-p-y">
        <div class="d-flex justify-content-between">
            <h4 class="fw-bold">Новый пользователь</h4>
            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb" class="d-flex align-items-center">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/}">Главная</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/users}">Пользователи</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Новый пользователь</li>
                </ol>
            </nav>
        </div>
        <hr style="margin-top: -5px">

        <ul class="nav nav-pills mb-3" role="tablist" id="navigationBlock">
            <li class="nav-item">
                <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab"
                        data-bs-target="#navs-pills-top-info" aria-controls="navs-pills-top-home" aria-selected="true">
                    Информация
                </button>
            </li>
            <li class="nav-item">
                <button type="button" class="nav-link" role="tab" data-bs-toggle="tab"
                        data-bs-target="#navs-pills-top-reviews" aria-controls="navs-pills-top-profile"
                        aria-selected="false">Отзывы
                </button>
            </li>
        </ul>
        <div class="card">
            <div class="card-body">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="navs-pills-top-info">
                            <div class="row">
                                <div class="col-6">
                                    <img id="previewImage" class="pull-left img-responsive mb-2"
                                         src="http://myhouse24.avada-media.ua/site/glide?path=%2Fupload%2Fplaceholder.jpg"
                                         style="width: 50%; height: 200px">
                                    <input type="file" class="form-control fileInput" accept=".jpg, .jpeg, .png"
                                           onchange="validateAndUpload('previewImage', ['.jpg', '.jpeg', '.png'])"
                                           th:id="img">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Филиалы</label>
                                    <select id="branchSelect2Multiple" name="branches" multiple>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Роль</label>
                                    <select id="roleSelect2" name="roles" class="form-select"></select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Фамилия</label>
                                    <input id="surname" type="text" class="form-control"
                                           placeholder="Пушкин" aria-describedby="defaultFormControlHelp"/>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Имя</label>
                                    <input type="text" class="form-control" id="name"
                                           placeholder="Александр" aria-describedby="defaultFormControlHelp"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Отчество</label>
                                    <input type="text" class="form-control" id="middleName"
                                           placeholder="Сергеевич" aria-describedby="defaultFormControlHelp"/>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Телефон</label>
                                    <input type="tel" class="form-control" id="phone"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Email</label>
                                    <input type="text" class="form-control" id="email"
                                           placeholder="test@gmail.com" aria-describedby="defaultFormControlHelp"/>
                                </div>
                            </div>
                            <div class="row">
                                <h3>Сменить пароль</h3>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Новый пароль</label>
                                    <input type="password" class="form-control" id="password"
                                           aria-describedby="defaultFormControlHelp"/>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Повтор пароля</label>
                                    <input type="password" class="form-control" id="confirmPassword"
                                           aria-describedby="defaultFormControlHelp"/>
                                </div>
                            </div>
                    </div>
                    <div class="tab-pane fade" id="navs-pills-top-reviews">
                        <div class="row">
                            <h5>Прикрепить PDF файлы</h5>
                            <input type="file" name="" id="">
                            <ul>
                                <div class="row">
                                    <div class="col-1">1.pdf</div>
                                    <div class="col-2"><a href="#">Скачать файл</a></div>
                                    <div class="col-1"><a href="#">х Удалить</a></div>
                                </div>
                                <div class="row">
                                    <div class="col-1">1.pdf</div>
                                    <div class="col-2"><a href="#">Скачать файл</a></div>
                                    <div class="col-1"><a href="#">х Удалить</a></div>
                                </div>
                                <div class="row">
                                    <div class="col-1">1.pdf</div>
                                    <div class="col-2"><a href="#">Скачать файл</a></div>
                                    <div class="col-1"><a href="#">х Удалить</a></div>
                                </div>
                            </ul>
                        </div>
                        <div class="row">
                            <div class="row">
                                <div class="col-5">
                                    <label>Имя</label>
                                    <input type="text" class="form-control" name="" id="">
                                </div>
                                <div class="col-5">
                                    <label>Контакт</label>
                                    <input type="text" class="form-control" name="" id="">
                                </div>
                                <div class="col-1">
                                    [icon]
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-10">
                                    <label>Отзыв</label>
                                    <textarea name="" class="form-control" id="" cols="30" rows="10"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="row">
                                <div class="col-5">
                                    <label>Имя</label>
                                    <input type="text" class="form-control" name="" id="">
                                </div>
                                <div class="col-5">
                                    <label>Контакт</label>
                                    <input type="text" class="form-control" name="" id="">
                                </div>
                                <div class="col-1">
                                    [icon]
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-10">
                                    <label>Отзыв</label>
                                    <textarea name="" class="form-control" id="" cols="30" rows="10"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-end">
                    <button class="btn btn-default">Отменить</button>
                    <button onclick="sendForm()" class="btn btn-success">Сохранить</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            if(getLastDigitFromPath(window.location.pathname) != null){
                $.ajax({
                    url: '[[@{/users/get/id/}]]'+getLastDigitFromPath(window.location.pathname),
                    success: function (user) {
                        $("#name").value = user.name
                        $("#surname").value = user.surname
                        $("#middleName").value = user.middleName
                        $("#phone").value = user.phone
                        $("#email").value = user.email
                        roleSelect2(user.roles, user.roles)
                        $('#branchSelect2Multiple').select2({
                            placeholder: "Філіали",
                            ajax: {
                                url: '[[@{/branches/for/select}]]',
                                dataType: 'json',
                                delay: 1500,
                                data: function (params) {
                                    var number = params.page > 0 ? params.page - 1 : 0;
                                    return {
                                        query: params.term || '',
                                        page: number,
                                        size: 10
                                    };
                                },
                                processResults: function (data, params) {
                                    var results = data.content.map(function (item) {
                                        return {id: item.id, text: item.name};
                                    });
                                    var hasMore = data.totalPages > data.number;
                                    return {
                                        results: results,
                                        pagination: {
                                            more: hasMore
                                        }
                                    };
                                },
                            }
                        })
                        for (var branch of user.branches) {
                            $('#branchSelect2').append(new Option(branch.name, branch.id, true, true));
                        }
                    },
                    error: function (xhr, status, error) {
                        var errors = JSON.parse(xhr.responseText);
                        errors.forEach(function (error) {
                            console.log("Ошибка: " + error);
                            showNotification("Ошибка!", error, false);
                        });
                    }
                })
            }else {
                $("#navigationBlock").css("display", "none")
                roleSelect2()
                $('#branchSelect2Multiple').select2({
                    placeholder: "Філіали",
                    ajax: {
                        url: '[[@{/branches/for/select}]]',
                        dataType: 'json',
                        delay: 1500,
                        data: function (params) {
                            var number = params.page > 0 ? params.page - 1 : 0;
                            return {
                                query: params.term || '',
                                page: number,
                                size: 10
                            };
                        },
                        processResults: function (data, params) {
                            var results = data.content.map(function (item) {
                                return {id: item.id, text: item.name};
                            });
                            var hasMore = data.totalPages > data.number;
                            return {
                                results: results,
                                pagination: {
                                    more: hasMore
                                }
                            };
                        },
                    }
                })
            }
        })
        function sendForm() {
            var img = $("#img").prop("files")[0];
            var branches = $("#branchSelect2Multiple").val();
            var role = $("#roleSelect2").val();
            var name = $("#name").val();
            var surname = $("#surname").val();
            var middleName = $("#middleName").val();
            var phone = $("#phone").val();
            var email = $("#email").val();
            var password = $("#password").val();
            var confirmPassword = $("#confirmPassword").val();

            $("#img").css("border-color", "");
            if (img === undefined) {
                showToast("Фото повино бути завантажене", "danger")
                $("#img").css("border-color", "#ff0000");
                return;
            }
            $("#branchSelect2Multiple").next().find(".select2-selection").css("border", "");
            if (branches.length === 0) {
                showToast("Повинен бути вибраний хоть один філіал", "danger")
                $("#branchSelect2Multiple").next().find(".select2-selection").css("border", "1px solid #ff0000");
                return;
            }
            $("#roleSelect2").next().find(".select2-selection").css("border", "");
            if (role == null) {
                showToast("Роль повина бути вибрана", "danger")
                $("#roleSelect2").next().find(".select2-selection").css("border", "1px solid #ff0000");
                return;
            }
            $("#name").css("border-color", "");
            if (!validString("3", "50", name)) {
                showToast("Ім'я повинно бути від 3 до 50 символів", "danger")
                $("#name").css("border-color", "#ff0000");
                return;
            }
            $("#surname").css("border-color", "");
            if (!validString("3", "50", surname)) {
                showToast("Ім'я повинно бути від 3 до 50 символів", "danger")
                $("#surname").css("border-color", "#ff0000");
                return;
            }
            $("#middleName").css("border-color", "");
            if (!validString("3", "50", middleName)) {
                showToast("Ім'я повинно бути від 3 до 50 символів", "danger")
                $("#middleName").css("border-color", "#ff0000");
                return;
            }
            $("#phone").css("border-color", "");
            if (!validatePhoneNumber(phone)) {
                showToast("Телефон не коректний", "danger")
                $("#phone").css("border-color", "#ff0000");
                return;
            }
            $("#email").css("border-color", "");
            if (!validateEmail(email)) {
                showToast("Email не коректний", "danger")
                $("#email").css("border-color", "#ff0000");
                return;
            }
            $("#password").css("border-color", "");
            if (!validString(8, 50, password)) {
                showToast("Пароль повинен містити від 8 до 50 символів", "danger")
                $("#password").css("border-color", "#ff0000");
                return;
            }
            $("#password").css("border-color", "");
            $("#confirmPassword").css("border-color", "");
            if (!validString(8, 50, password)) {
                showToast("Паролі не співпадають", "danger")
                $("#password").css("border-color", "#ff0000");
                $("#confirmPassword").css("border-color", "#ff0000");
                return;
            }
            let formData = new FormData();
            formData.append("name", name)
            formData.append("email", email)
            formData.append("branches", branches)
            formData.append("roles", role)
            formData.append("name", name)
            formData.append("surname", surname)
            formData.append("middleName", middleName)
            formData.append("phone", phone)
            formData.append("password", password)
            formData.append("confirmPassword", confirmPassword)
            formData.append("img", img)

            $.ajax({
                url: '[[@{/users/add}]]',
                method: "POST",
                cache: false,
                processData: false,
                contentType: false,
                data: formData,
                success: function () {
                    showToast("Елемент успішно збережений", "access")
                },
                error: function (xhr, status, error) {
                    var errors = JSON.parse(xhr.responseText);
                    errors.forEach(function (error) {
                        console.log("Ошибка: " + error);
                        showNotification("Ошибка!", error, false);
                    });
                }
            })
        }
    </script>
</section>

</body>
</html>