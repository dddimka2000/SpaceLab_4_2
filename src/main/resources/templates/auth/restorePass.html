<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      class="light-style customizer-hide" dir="ltr" data-theme="theme-default"
      data-template="horizontal-menu-template-no-customizer">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="">
    <title data-translate="відновлення_паролю"></title>
    <link rel="icon" type="image/x-icon"
          th:href="@{/img/favicon/1644809631_5-abrakadabra-fun-p-domik-na-belom-fone-12.png}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <link rel="icon" type="image/x-icon"
          th:href="@{/img/favicon/1644809631_5-abrakadabra-fun-p-domik-na-belom-fone-12.png}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.maskedinput@1.4.1/src/jquery.maskedinput.min.js"
            type="text/javascript"></script>
    <link rel="stylesheet" th:href="@{/vendor/fonts/fontawesome.css}">
    <link rel="stylesheet" th:href="@{/vendor/fonts/tabler-icons.css}">
    <link rel="stylesheet" th:href="@{/vendor/fonts/flag-icons.css}">
    <!-- Core CSS -->
    <link rel="stylesheet" th:href="@{/css/demo.css}">
    <!-- Vendors CSS -->
    <link rel="stylesheet" th:href="@{/vendor/libs/perfect-scrollbar/perfect-scrollbar.css}">
    <link rel="stylesheet" th:href="@{/vendor/libs/node-waves/node-waves.css}">
    <link rel="stylesheet" th:href="@{/vendor/libs/typeahead-js/typeahead.css}">
    <link rel="stylesheet" th:href="@{/vendor/libs/select2/select2.css}">
    <link rel="stylesheet" th:href="@{/vendor/libs/formvalidation/dist/css/formValidation.min.css}">
    <link rel="stylesheet" th:href="@{/vendor/libs/animate-css/animate.css}">
    <link rel="stylesheet" th:href="@{/vendor/libs/sweetalert2/sweetalert2.css}">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script th:src="@{/vendor/js/helpers.js}"></script>
    <script th:src="@{/vendor/js/template-customizer.js}"></script>
    <script th:src="@{/js/config.js}"></script>
    <link rel="stylesheet" type="text/css" th:href="@{/vendor/css/rtl/core.css}"
          class="template-customizer-core-css">
    <link rel="stylesheet" type="text/css" th:href="@{/vendor/css/rtl/theme-default.css}"
          class="template-customizer-theme-css">
    <style>
        .background-element {
            width: 100%;
            height: 100vh;
            background-size: cover; /* Растягивать фон, чтобы он покрывал всю видимую область */
            background-image: url("https://www.cartoonbrew.com/wp-content/uploads/2022/07/minions_riseofgru_bo.jpg")
        }

        .container {
            display: flex;
            justify-content: center; /* Горизонтальное выравнивание по центру */
            align-items: center; /* Вертикальное выравнивание по центру */
            height: 100vh; /* 100% высоты видимой области окна браузера */
        }

        .notification {
            position: fixed;
            top: 90px;
            right: 40px; /* Расстояние справа */
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
            transition: opacity 0.5s ease-in-out;
        }

        .notification.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>


</head>
<div class="background-element">
    <div class="container">
        <!-- Login -->
        <div class="card">
            <div class="card-body" style="flex-grow: 1; width: 600px">
                <!-- Logo -->
                <div class="app-brand justify-content-center mb-4 mt-2">
                  <span class="app-brand-logo">
                    <img width="70" height="auto"
                         th:src="@{/img/favicon/1644809631_5-abrakadabra-fun-p-domik-na-belom-fone-12.png}">
                  </span>
                </div>
                <!-- /Logo -->
                <h4 class="mb-1 pt-2" style="text-align: center">Восстановление пароля</h4>
                <p class="mb-4" style="text-align: center"></p>
                <div th:if="${param.error}" style="text-align: center">
                    <div class="alert alert-danger" role="alert"> Данного E-mail не существует</div>
                </div>
                <form id="formAuthentication" class="mb-3 fv-plugins-bootstrap5 fv-plugins-framework"
                      th:action="@{/auth/process_login}" method="POST" novalidate="novalidate">
                    <div class="mb-3 fv-plugins-icon-container">
                        <input type="hidden" th:value="${_csrf}" name="_csrf">
                        <label class="form-label" id="labelInput">Email</label>
                        <input type="text" class="form-control" id="username"
                               name="username"
                               placeholder="Введите Email" autofocus="">
                        <div class="fv-plugins-message-container invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-primary d-grid w-100 waves-effect waves-light" id="sendEmail"
                                type="button">
                            Отправить письмо с кодом
                        </button>
                    </div>
                    <input type="hidden">
                </form>

                <p class="text-center">
                    <a th:href="@{/auth/login}">
                        <span>Войти в аккаунт</span>
                    </a>
                </p>
            </div>
        </div>
        <!-- /Register -->
    </div>
</div>
</div>
<div class="alert alert-warning notification  d-flex align-items-center hidden" role="alert"
     id="notification">

    <strong id="text_notification"></strong>
    <div>
        <span id="notification-message"></span>
    </div>
</div>
</body>
<script th:inline="javascript">
    let code="";
    let email="";
    $("#sendEmail").click(function () {
        email = $("#username").val();
        let contextPath =/*[[@{/auth/login/restore_password}]]*/'';
        console.log(email)
        $.ajax({
            url: contextPath,
            data: {email: email},
            method: "POST",
            dataType: 'json',
            success: function (data) {
                if (data.message == 'Code sent') {
                    let input = $("#username");
                    input.attr("placeholder", "Введите код");
                    input.val("");

                    let label = $("#labelInput");
                    label.text("Введите код");

                    let button = $("#sendEmail");
                    button.text("Проверить код");
                    button.off("click");
                    button.on("click", checkCode);

                } else {
                    showNotification("Пользователя с таким E-mail не существует", "", false);
                }
            },
            error: function (data) {
                console.log(data);
                if (data && data.responseJSON && data.responseJSON.message === 'Doesn\'t  exist user with so E-mail') {
                    showNotification("Пользователя с таким E-mail не существует", "", false);
                }
            }
        })
    });

    function checkCode() {
        let contextPath =/*[[@{/auth/login/existsByCode}]]*/'';
        code = $("#username").val();
        $.ajax({
            url: contextPath,
            data: {
                code: code,
                email: email
            },
            method: "POST",
            dataType: 'json',
            success: function (data) {
                if (data.message == 'Code verified') {
                    let button = $("#sendEmail");
                    button.text("Подтвердить новый пароль");
                    button.off("click");
                    button.on("click", newPassword);
                    let input = $("#username");
                    input.attr("placeholder", "Введите новый пароль");
                    input.val("");
                    let label = $("#labelInput");
                    label.text("Введите новый пароль");
                } else {
                    showNotification("Неверный код", "", false);
                }
            },
            error: function (data) {
                console.log(data);
                if (data && data.responseJSON && data.responseJSON.message === 'The code is different from the one sent by email') {
                    showNotification("Код отличается от отправленного на почту", "", false);
                }
            }
        })
    }

    function newPassword() {
        let contextPath =/*[[@{/auth/login/newPassword}]]*/'';
        let newPassword = $("#username").val();
        $.ajax({
            url: contextPath,
            data: {
                code:code,
                email:email,
                newPassword:newPassword
            },
            method: "POST",
            dataType: 'json',
            success: function (data) {
                if (data.message == 'Пароль изменен') {
                    window.location.href =/*[[@{/auth/login?newPassword}]]*/'';
                } else {
                    showNotification("Неверный код", "", false);
                }
            },
            error: function (data) {
                console.log(data);
                if (data && data.responseJSON && data.responseJSON.message === 'The code is different from the one sent by email') {
                    showNotification("Код отличается от отправленного на почту", "", false);
                }
            }
        })
    }


    function showNotification(bigTextMessage, message, isSuccess) {
        const notification = document.getElementById("notification");
        const notificationMessage = document.getElementById("notification-message");

        var element = document.getElementById("text_notification");
        element.textContent = bigTextMessage;

        notificationMessage.textContent = message;
        notification.classList.remove("hidden");
        notification.classList.toggle("alert-success", isSuccess);
        notification.classList.toggle("alert-warning", !isSuccess);
        setTimeout(() => {
            notification.classList.add("hidden");
        }, 5000);
    }

</script>
</html>