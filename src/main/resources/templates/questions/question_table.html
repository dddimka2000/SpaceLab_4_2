<!DOCTYPE html>

<html
        lang="en"
        class="light-style layout-navbar-fixed layout-menu-fixed"
        layout:decorate="~{layout.html}"
        xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <title>Content page</title>
</head>

<body>

<section layout:fragment="content">
    <div class="container-xxl flex-grow-1 container-p-y">
        <div class="d-flex justify-content-between">
            <h4 class="fw-bold">Вопроси</h4>
            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb" class="d-flex align-items-center">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/}">Главная</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Вопроси</li>
                </ol>
            </nav>
        </div>
        <hr style="margin-top: -5px">
        <div class="card border">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-striped linkedRow" id="questionTable">
                        <thead>
                        <tr>
                            <th>Вопрос</th>
                            <th>Ответ</th>
                            <th style="min-width: 130px"></th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <ul class="pagination pagination-sm m-0 mt-1" style="display: flex; justify-content: flex-end"
                    id="pagination_container">
                </ul>
            </div>
        </div>
    </div>
    <div class="modal animate__animated animate__flipInX" id="flipInXAnimationModal" tabindex="-1"
         aria-labelledby="flipInXAnimationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Вопроси</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    </button>
                </div>
                <div class="modal-body">
                    Имя
                    <input name="id" hidden>
                    <input class="form-control" name="name" placeholder="Денис">
                    Email
                    <input class="form-control" name="email" placeholder="some.email@gmail.com">
                    Телефон
                    <input class="form-control" name="phone" placeholder="+380123456789">
                    Вопрос
                    <textarea class="form-control" name="question" rows="3"
                              placeholder="Питання питання питання питанння ..."></textarea>
                    Ответ
                    <textarea class="form-control" name="answer" rows="3"
                              placeholder="Відповідь відповідь відповідь ..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveElement()">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <script th:src="@{/js/pagination.js}"></script>
    <script>
        $(document).ready(function () {
            getPageWithFilter(0)
        })

        function saveElement() {
            var modalElement = document.getElementById('flipInXAnimationModal')

            var id = modalElement.querySelector('input[name="id"]')
            var name = modalElement.querySelector('input[name="name"]')
            var email = modalElement.querySelector('input[name="email"]')
            var phone = modalElement.querySelector('input[name="phone"]')
            var question = modalElement.querySelector('textarea[name="question"]')
            var answer = modalElement.querySelector('textarea[name="answer"]')

            name.style.borderColor = "";
            if (!validString(3, 25, name.value)) {
                showToast("Ім'я повино містити від 3 до 25 символів", "danger")
                name.style.borderColor = "#ff0000";
                return;
            }
            email.style.borderColor = "";
            if (!validateEmail(email.value)) {
                showToast("Email не коректний", "danger")
                email.style.borderColor = "#ff0000";
                return;
            }
            phone.style.borderColor = "";
            if (!validatePhoneNumber(phone.value)) {
                showToast("Номер телефону повинен бути в такому форматі +380_________", "danger")
                phone.style.borderColor = "#ff0000";
                return;
            }
            question.style.borderColor = "";
            if (!validString(5, 1500, name.value)) {
                showToast("Питання повино складатись від 5 до 1500 символів", "danger")
                question.style.borderColor = "#ff0000";
                return;
            }
            answer.style.borderColor = "";
            if (!validString(5, 1500, name.value)) {
                showToast("Відповідь повина складатись від 5 до 1500 символів", "danger")
                answer.style.borderColor = "#ff0000";
                return;
            }

            let formData = new FormData();
            formData.append("id", id.value)
            formData.append("name", name.value)
            formData.append("email", email.value)
            formData.append("phone", phone.value)
            formData.append("question", question.value)
            formData.append("answer", answer.value)

            $.ajax({
                url: '[[@{/questions/edit}]]',
                method: "POST",
                cache: false,
                processData: false,
                contentType: false,
                data: formData,
                success: function (response){
                    showToast(response, "success")
                }
            })
        }

        function editQuestion(id) {
            $.ajax({
                type: "Get",
                url: '[[@{/questions/getById}]]',
                data: {
                    id: id
                },
                success: function (question) {
                    var modal = new bootstrap.Modal(document.getElementById('flipInXAnimationModal'))
                    var modalElement = document.getElementById('flipInXAnimationModal')
                    modalElement.querySelector('input[name="id"]').value = question.id
                    modalElement.querySelector('input[name="name"]').value = question.name
                    modalElement.querySelector('input[name="email"]').value = question.email
                    modalElement.querySelector('input[name="phone"]').value = question.phone
                    modalElement.querySelector('textarea[name="question"]').value = question.question
                    modalElement.querySelector('textarea[name="answer"]').value = question.answer
                    modal.show()
                }
            })


        }

        function getPageWithFilter(page) {
            this.page = page
            $.ajax({
                type: "Get",
                url: '[[@{/questions/get-all}]]',
                data: {
                    page: page
                },
                success: function (questions) {
                    var table = document.getElementById("questionTable");
                    var tbody = table.querySelector("tbody");
                    $('#questionTable tbody').empty();

                    for (var question of questions.content) {
                        var newRow = tbody.insertRow();
                        var questionId = question.id;
                        var cell1 = newRow.insertCell(0);
                        cell1.innerHTML = textForTable(question.question, 40);
                        // cell1.setAttribute('onclick', 'window.location.href="[[@{/questions/}]]' + questionId + '"');

                        var cell2 = newRow.insertCell(1);
                        cell2.innerHTML = textForTable(question.answer, 40);
                        // cell2.setAttribute('onclick', 'window.location.href="[[@{/realtors/}]]' + questionId + '"');

                        var cell3 = newRow.insertCell(2);
                        cell3.innerHTML = `
                        <button class='btn btn-default btn-sm float-right' onclick="deleteElement(this, ` + question.id + `);" title='Удалить'><i class='fa fa-trash'></i></button>
                        <button class='btn btn-default btn-sm float-right' onclick="editQuestion(` + question.id + `)" title='Редактировать'><i class='fa fa-pencil-alt'></i></button>`;
                    }
                    $('#pagination_container').empty();
                    if (questions.totalPages > 1) updatePagination(page, questions.totalPages, 'pagination_container')
                },
            });
        }
    </script>
</section>

</body>
</html>